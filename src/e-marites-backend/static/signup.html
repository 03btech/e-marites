<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" href="assets/images/megaphone.svg" type="image/x-icon" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Account - Rural Community Mishaps System</title>
    <link
      rel="stylesheet"
      href="js/bootstrap-5.3.5-dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="js/bootstrap-icons-1.11.3/font/bootstrap-icons.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .signup-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .signup-header {
        text-align: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
      }
      .signup-title {
        color: #283444;
        font-weight: 600;
      }
      .form-section {
        margin-bottom: 1.5rem;
      }
      .form-section h5 {
        color: #283444;
        margin-bottom: 1rem;
      }
      .btn-signup {
        background-color: #283444;
        color: white;
        padding: 0.5rem 2rem;
        font-weight: 500;
      }
      .btn-signup:hover {
        background-color: #1e293b;
        color: white;
      }
      .info-bar {
        background-color: #283444;
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        align-items: center;
        font-size: 0.95rem;
        margin-bottom: 2rem;
      }

      .info-item {
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
      }
      .info-icon {
        font-size: 1.1rem;
      }
      .password-strength {
        height: 5px;
        background-color: #e9ecef;
        margin-top: 5px;
        border-radius: 3px;
        overflow: hidden;
      }
      .password-strength-bar {
        height: 100%;
        width: 0%;
        transition: width 0.3s, background-color 0.3s;
      }
      .form-text.password-requirements {
        font-size: 0.8rem;
        color: #6c757d;
      }
      .profile-image-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #dee2e6;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="info-bar">
        <div class="info-item">
          <i class="bi bi-calendar info-icon"></i>
          <span id="current-date">Loading date...</span>
        </div>
        <div class="info-item">
          <i class="bi bi-geo-alt-fill info-icon"></i>
          <span>BARANGAY POBLACION, CAUAYAN NEGROS OCCIDENTAL</span>
        </div>
        <div class="info-item">
          <i class="bi bi-clock-fill info-icon"></i>
          <span id="current-time">Loading time...</span>
        </div>
      </div>

      <div class="signup-container">
        <div class="signup-header">
          <h2 class="signup-title">
            <i class="bi bi-person-plus-fill me-2"></i>Create Your Account
          </h2>
          <p class="text-muted">
            Join the Rural Community Mishaps Reporting System
          </p>
        </div>

        <form id="signupForm">
          <div class="form-section">
            <h5><i class="bi bi-person-circle me-2"></i>Account Information</h5>
            <div class="mb-3">
              <label for="username" class="form-label">Username*</label>
              <input
                type="text"
                class="form-control"
                id="username"
                required
                placeholder="Choose a username"
              />
              <div class="form-text">
                Must be unique and 4-50 characters long
              </div>
            </div>

            <div class="mb-3">
              <label for="email" class="form-label">Email Address*</label>
              <input
                type="email"
                class="form-control"
                id="email"
                required
                placeholder="your.email@example.com"
              />
            </div>

            <div class="mb-3">
              <label for="password" class="form-label">Password*</label>
              <input
                type="password"
                class="form-control"
                id="password"
                required
                placeholder="Create a strong password"
              />
              <div class="password-strength">
                <div
                  class="password-strength-bar"
                  id="passwordStrengthBar"
                ></div>
              </div>
              <div class="form-text password-requirements">
                Password must contain at least 8 characters, including
                uppercase, lowercase, numbers, and special characters
              </div>
            </div>

            <div class="mb-3">
              <label for="confirmPassword" class="form-label"
                >Confirm Password*</label
              >
              <input
                type="password"
                class="form-control"
                id="confirmPassword"
                required
                placeholder="Re-enter your password"
              />
              <div class="invalid-feedback">Passwords do not match</div>
            </div>
          </div>

          <div class="form-section">
            <h5><i class="bi bi-card-text me-2"></i>Personal Information</h5>
            <div class="mb-3">
              <label for="fullName" class="form-label">Full Name*</label>
              <input
                type="text"
                class="form-control"
                id="fullName"
                required
                placeholder="Juan Dela Cruz"
              />
            </div>

            <div class="mb-3">
              <label for="phone" class="form-label">Phone Number</label>
              <input
                type="tel"
                class="form-control"
                id="phone"
                placeholder="09123456789"
              />
              <div class="form-text">
                Include country code if outside Philippines
              </div>
            </div>

            <div class="mb-3">
              <label for="role" class="form-label">Account Type*</label>
              <select class="form-select" id="role" required>
                <option value="reporter" selected>Community Reporter</option>
                <option value="responder">Emergency Responder</option>
                <option value="admin">Administrator</option>
              </select>
            </div>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-signup">
              <i class="bi bi-person-check-fill me-1"></i> Create Account
            </button>
            <div class="text-center mt-3">
              Already have an account?
              <a href="login.html">Sign in here</a>
            </div>
          </div>
        </form>
      </div>
    </div>

    <script src="js/bootstrap-5.3.5-dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function updateDateTime() {
        const now = new Date();

        const options = { month: "long", day: "2-digit", year: "numeric" };
        document.getElementById("current-date").textContent = now
          .toLocaleDateString("en-US", options)
          .toUpperCase();

        document.getElementById("current-time").textContent = `TIME: ${now
          .getHours()
          .toString()
          .padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;
      }

      updateDateTime();
      setInterval(updateDateTime, 60000);

      document
        .getElementById("password")
        .addEventListener("input", function (e) {
          const password = e.target.value;
          const strengthBar = document.getElementById("passwordStrengthBar");
          let strength = 0;

          if (password.length > 7) strength += 1;
          if (password.length > 11) strength += 1;

          if (/[A-Z]/.test(password)) strength += 1;
          if (/[a-z]/.test(password)) strength += 1;
          if (/[0-9]/.test(password)) strength += 1;
          if (/[^A-Za-z0-9]/.test(password)) strength += 1;

          let width = 0;
          let color = "#dc3545";

          if (strength >= 6) {
            width = 100;
            color = "#28a745";
          } else if (strength >= 4) {
            width = 75;
            color = "#ffc107";
          } else if (strength >= 2) {
            width = 50;
            color = "#fd7e14";
          } else if (password.length > 0) {
            width = 25;
          }

          strengthBar.style.width = `${width}%`;
          strengthBar.style.backgroundColor = color;
        });

      document
        .getElementById("confirmPassword")
        .addEventListener("input", function (e) {
          const password = document.getElementById("password").value;
          const confirmPassword = e.target.value;

          if (password !== confirmPassword && confirmPassword.length > 0) {
            e.target.classList.add("is-invalid");
          } else {
            e.target.classList.remove("is-invalid");
          }
        });

      document
        .getElementById("signupForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const password = document.getElementById("password").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;

          if (password !== confirmPassword) {
            alert("Passwords do not match");
            return;
          }

          if (
            password.length < 8 ||
            !/[A-Z]/.test(password) ||
            !/[a-z]/.test(password) ||
            !/[0-9]/.test(password) ||
            !/[^A-Za-z0-9]/.test(password)
          ) {
            alert("Password does not meet strength requirements");
            return;
          }

          const formData = {
            username: document.getElementById("username").value,
            email: document.getElementById("email").value,
            password: password,
            full_name: document.getElementById("fullName").value,
            phone: document.getElementById("phone").value,
            role: document.getElementById("role").value,
          };

          if (
            !formData.username ||
            !formData.email ||
            !formData.password ||
            !formData.full_name
          ) {
            alert("Please fill all required fields");
            return;
          }

          try {
            const submitBtn = document.querySelector(
              "#signupForm button[type='submit']"
            );
            submitBtn.disabled = true;
            submitBtn.innerHTML =
              '<i class="bi bi-arrow-repeat me-1"></i> Creating Account...';

            const response = await fetch("/api/signup", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || "Failed to create account");
            }

            alert("Account created successfully! You can now log in.");

            this.reset();

            window.location.href = "login.html";
          } catch (error) {
            console.error("Signup error:", error);
            alert(
              error.message || "Failed to create account. Please try again."
            );
          } finally {
            const submitBtn = document.querySelector(
              "#signupForm button[type='submit']"
            );
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.innerHTML =
                '<i class="bi bi-person-check-fill me-1"></i> Create Account';
            }
          }
        });
    </script>
  </body>
</html>
