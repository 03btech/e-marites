<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" href="assets/images/megaphone.svg" type="image/x-icon" />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Community Event Reporting Portal</title>
    <link rel="stylesheet" href="./js/leaflet/leaflet.css" />
    <link rel="stylesheet" href="./js/leaflet/Control.FullScreen.css" />

    <!-- Bootstrap 5.3.5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .reporting-portal {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .portal-header {
        text-align: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
      }
      .portal-title {
        color: #283444;
        font-weight: 600;
      }
      .form-section {
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background-color: #f8f9fa;
        border-radius: 8px;
      }
      .form-section h5 {
        color: #283444;
        margin-bottom: 1rem;
      }
      .btn-submit {
        background-color: #283444;
        color: white;
        padding: 0.5rem 2rem;
        font-weight: 500;
      }
      .btn-submit:hover {
        background-color: #1e293b;
        color: white;
      }
      .info-bar {
        background-color: #283444;
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
        margin-bottom: 2rem;
      }
      .info-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .info-icon {
        font-size: 1.1rem;
      }
      #e-MARITES {
        font-size: 35px;
        font-weight: 800;
      }
      #map-container {
        height: 200px;
        width: 100%;
        border-radius: 8px;
      }
      .leaflet-control-fullscreen a {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black" width="18px" height="18px"><path d="M0 0h24v24H0z" fill="none"/><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>');
        background-size: 16px 16px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Info Bar -->
      <div class="info-bar">
        <div class="info-item">
          <i class="bi bi-calendar info-icon"></i>
          <span id="current-date">Loading date...</span>
        </div>
        <div class="info-item">
          <i class="bi bi-geo-alt-fill info-icon"></i>
          <span>BARANGAY POBLACION, CAUAYAN NEGROS OCCIDENTAL</span>
        </div>
        <div class="info-item">
          <i class="bi bi-clock-fill info-icon"></i>
          <span id="current-time">Loading time...</span>
        </div>
      </div>

      <!-- Reporting Portal Card -->
      <div class="reporting-portal">
        <div class="portal-header">
          <h2 class="portal-title">
            <i class="bi bi-megaphone-fill me-2"></i
            ><span id="e-MARITES">e-MARITES</span><br />Community Event
            Reporting
          </h2>
          <p class="text-muted">
            Report any incidents, hazards, or community events
          </p>
        </div>

        <form id="eventReportForm">
          <!-- Event Details Section -->
          <div class="form-section">
            <h5><i class="bi bi-info-circle me-2"></i>Event Details</h5>
            <div class="mb-3">
              <label for="eventType" class="form-label">Event Type</label>
              <select class="form-select" id="eventType" required>
                <option value="" selected disabled>Select event type</option>
                <option value="Accident">Vehicular Accident</option>
                <option value="Flooding">Flooding</option>
                <option value="Landslide">Landslide</option>
                <option value="Fire">Fire</option>
                <option value="Power Outage">Power Outage</option>
                <option value="Road Hazard">Road Hazard</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="eventSeverity" class="form-label"
                >Severity Level</label
              >
              <select class="form-select" id="eventSeverity" required>
                <option value="High">High - Immediate danger</option>
                <option value="Medium" selected>
                  Medium - Concerning situation
                </option>
                <option value="Low">Low - General information</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="eventDescription" class="form-label"
                >Description</label
              >
              <textarea
                class="form-control"
                id="eventDescription"
                rows="3"
                required
                placeholder="Provide details about the event..."
              ></textarea>
            </div>
          </div>

          <!-- Location Details Section -->
          <div class="form-section">
            <h5><i class="bi bi-geo-alt me-2"></i>Location Details</h5>
            <div class="mb-3">
              <label for="eventLocation" class="form-label"
                >Specific Location</label
              >
              <input
                type="text"
                class="form-control"
                id="eventLocation"
                required
                placeholder="e.g. Near the market, Main Road kilometer 12..."
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Approximate Location on Map</label>
              <div class="input-group mb-2">
                <input
                  type="text"
                  id="address-search"
                  class="form-control"
                  placeholder="Search for an address..."
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  id="search-button"
                >
                  <i class="bi bi-search"></i> Search
                </button>
              </div>
              <div id="map-container" style="height: 300px"></div>
              <small class="text-muted"
                >Click on the map to mark the event location or search for an
                address above</small
              >
              <input type="hidden" id="coordinates" name="coordinates" />
            </div>
          </div>

          <!-- Reporter Information Section -->
          <div class="form-section">
            <h5>
              <i class="bi bi-person-circle me-2"></i>Community Member
              Information
            </h5>
            <div class="mb-3">
              <label for="communityMemberFullName" class="form-label"
                >Community Member</label
              >
              <input
                type="text"
                class="form-control"
                id="communityMemberFullName"
                required
                placeholder="Juan Dela C. Cruz"
              />
            </div>

            <div class="mb-3">
              <label for="communityMemberContact" class="form-label"
                >Community Member</label
              >
              <input
                type="text"
                class="form-control"
                id="communityMemberContact"
                placeholder="Phone number"
              />
            </div>
          </div>

          <!-- Submission Section -->
          <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <button type="reset" class="btn btn-outline-secondary me-md-2">
              <i class="bi bi-x-circle me-1"></i> Clear Form
            </button>
            <button type="submit" class="btn btn-submit">
              <i class="bi bi-send-fill me-1"></i> Submit Report
            </button>
          </div>
        </form>
      </div>

      <!-- Success Modal (hidden by default) -->
      <div
        class="modal fade"
        id="successModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title">
                <i class="bi bi-check-circle-fill me-2"></i>Report Submitted
              </h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <p>
                Thank you for your community report. Your information has been
                received and will be reviewed by our response team.
              </p>
              <p class="mb-0">
                <strong>Reference ID:</strong>
                <span id="referenceId">CM-2023-001</span>
              </p>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-success"
                data-bs-dismiss="modal"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5.3.5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Update current date and time
      function updateDateTime() {
        const now = new Date();

        // Format date (e.g., APRIL 04, 2025)
        const options = { month: "long", day: "2-digit", year: "numeric" };
        document.getElementById("current-date").textContent = now
          .toLocaleDateString("en-US", options)
          .toUpperCase();

        // Format time (e.g., 14:30)
        document.getElementById("current-time").textContent = `TIME: ${now
          .getHours()
          .toString()
          .padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;
      }

      // Update immediately and then every minute
      updateDateTime();
      setInterval(updateDateTime, 60000);

      // Form submission handler
      document
        .getElementById("eventReportForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const coordInput = document.getElementById("coordinates");
          const coordinatesValue = coordInput.value;

          if (!coordinatesValue) {
            alert("Please select a location on the map");
            return;
          }

          const coords = coordinatesValue.split(",");
          if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
            alert(
              "Invalid coordinates format. Please reselect location on the map."
            );
            return;
          }

          // Prepare form dfullNameata
          // Prepare form data
          const formData = {
            event_type: document.getElementById("eventType").value,
            severity: document.getElementById("eventSeverity").value,
            description: document.getElementById("eventDescription").value,
            location: document.getElementById("eventLocation").value,
            coordinates: coordinatesValue,
            reporter_id: 1, // Ensure this is a number
            community_member: {
              full_name: document.getElementById("communityMemberFullName")
                .value,
              phone: document.getElementById("communityMemberContact").value,
            },
          };

          // Validate required fields
          if (
            !formData.event_type ||
            !formData.description ||
            !formData.location
          ) {
            alert(
              "Please fill all required fields (Event Type, Description, Specific Location)"
            );
            return;
          }

          try {
            console.log("Form Data:", formData);
            const submitBtn = document.querySelector(
              "#eventReportForm button[type='submit']"
            );
            submitBtn.disabled = true;
            submitBtn.innerHTML =
              '<i class="bi bi-arrow-repeat me-1"></i> Submitting...';

            const response = await fetch("/api/events", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });

            if (!response.ok) {
              const contentType = response.headers.get("content-type");
              if (contentType && contentType.includes("application/json")) {
                const errorData = await response.json();
                throw new Error(
                  errorData.error || `Server error: ${response.status}`
                );
              } else {
                const errorText = await response.text();
                throw new Error(
                  `Server error: ${response.status} - ${errorText}`
                );
              }
            }

            const data = await response.json();
            document.getElementById("referenceId").textContent =
              data?.reference_id || "N/A";

            const successModal = new bootstrap.Modal(
              document.getElementById("successModal")
            );
            successModal.show();

            this.reset();
            if (typeof marker !== "undefined" && marker !== null) {
              map.removeLayer(marker);
              marker = null;
              document.getElementById("coordinates").value = "";
            }
          } catch (error) {
            console.error("Submission error:", error);
            alert(`Failed to submit report: ${error.message}`);
          } finally {
            const submitBtn = document.querySelector(
              "#eventReportForm button[type='submit']"
            );
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.innerHTML =
                '<i class="bi bi-send-fill me-1"></i> Submit Report';
            }
          }
        });
    </script>

    <script src="./js/leaflet/leaflet.js"></script>
    <!-- Add this before your other scripts -->
    <script src="./js/leaflet/Control.FullScreen.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize map
        const map = L.map("map-container", {
          center: [10.6407, 122.9687],
          zoom: 13,
        });

        // Add tile layer (simplified - removed try/catch as it wouldn't catch tile loading errors)
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap contributors",
          maxZoom: 18,
        }).addTo(map);

        // Initialize Fullscreen control (CORRECTED)
        L.control
          .fullscreen({
            position: "topright",
            title: "View Fullscreen",
            titleCancel: "Exit Fullscreen",
            forceSeparateButton: true,
          })
          .addTo(map);

        // Marker variable
        let marker = null;

        // Local geocoding data
        const localGeocodingData = {
          // GOVERNMENT OFFICES
          "Toboso Municipal Hall": [10.714722, 123.516389],
          "Toboso Police Station (PNP)": [10.71485, 123.5167],
          "Bureau of Fire Protection (BFP) Toboso": [10.7149, 123.5162],
          "Toboso Post Office": [10.71465, 123.51655],

          // HEALTH FACILITIES
          "Toboso Rural Health Unit": [10.7145, 123.517],
          "Toboso Medicare Community Hospital": [10.7152, 123.5158],
          "Toboso Birthing Center": [10.7143, 123.5173],

          // EDUCATIONAL INSTITUTIONS
          "Toboso National High School": [10.713889, 123.518056],
          "Toboso Central Elementary School": [10.7135, 123.5185],
          "Don Julio Montelibano Memorial ES": [10.713, 123.519],
          "Toboso Science High School": [10.7137, 123.5178],
          "Toboso Day Care Center": [10.7141, 123.5171],

          // RELIGIOUS SITES
          "St. Joseph the Worker Parish Church": [10.714167, 123.516],
          "Toboso Evangelical Church": [10.71375, 123.5175],
          "Toboso United Methodist Church": [10.7144, 123.5168],

          // PUBLIC MARKETS & COMMERCE
          "Toboso Public Market": [10.714, 123.5172],
          "Toboso Town Plaza": [10.7143, 123.5163],
          "Toboso Cooperative Store": [10.7146, 123.5164],

          // TRANSPORT HUBS
          "Toboso Bus Terminal": [10.7155, 123.5155],
          "Toboso Tricycle Terminal": [10.7153, 123.5157],
          "Toboso Jeepney Stand": [10.715, 123.516],

          // BARANGAY HALLS
          "Barangay Salamanca Hall": [10.7165, 123.514],
          "Barangay Tabun-ac Hall": [10.7125, 123.519],
          "Barangay Bandila Hall": [10.717, 123.513],
          "Barangay San Isidro Hall": [10.711, 123.52],

          // NATURAL FEATURES
          "Malatan-og River": [10.712, 123.52],
          "Toboso Mangrove Forest": [10.716, 123.51],
          "Mount Mandalagan Trailhead": [10.71, 123.525],

          // RECREATIONAL
          "Toboso Sports Complex": [10.7132, 123.518],
          "Toboso Children's Park": [10.7142, 123.5167],
          "Toboso Basketball Court": [10.7139, 123.517],

          // LANDMARKS
          "Toboso Welcome Arch": [10.7158, 123.515],
          "Veterans Memorial Monument": [10.7144, 123.5165],
          "Toboso Historical Marker": [10.71435, 123.51645],

          // RURAL BARANGAYS
          "Sitio Proper Farm Cooperative": [10.72, 123.512],
          "Purok Magsaysay Meeting Hall": [10.718, 123.514],
          "Toboso Upland Farmers Center": [10.725, 123.51],
        };

        // Marker placement function
        function placeMarker(latlng, address = "") {
          if (marker) map.removeLayer(marker);

          marker = L.marker(latlng, {
            draggable: true,
            icon: new L.Icon.Default(), // Using default icon for simplicity
          }).addTo(map);

          if (address) {
            marker.bindPopup(`<b>${address}</b>`).openPopup();
          }

          document.getElementById(
            "coordinates"
          ).value = `${latlng.lat},${latlng.lng}`;

          marker.on("dragend", function (event) {
            const position = marker.getLatLng();
            document.getElementById(
              "coordinates"
            ).value = `${position.lat},${position.lng}`;
          });

          map.panTo(latlng);
        }

        // Map click handler
        map.on("click", function (e) {
          placeMarker(e.latlng);
        });

        // Address search function
        function searchAddress() {
          const query = document.getElementById("address-search").value.trim();
          if (!query) return;

          if (navigator.onLine) {
            // Online geocoding
            fetch(
              `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                query
              )}&limit=1`
            )
              .then((response) => response.json())
              .then((data) => {
                if (data.length > 0) {
                  const lat = parseFloat(data[0].lat);
                  const lng = parseFloat(data[0].lon);
                  placeMarker([lat, lng], query);
                  coordInput.value = `${lat},${lng}`; // Explicitly set coordinates
                } else {
                  tryLocalGeocoding(query);
                }
              })
              .catch(() => tryLocalGeocoding(query));
          } else {
            tryLocalGeocoding(query);
          }
        }

        // Local geocoding fallback
        function tryLocalGeocoding(query) {
          const normalizedQuery = query.toLowerCase();
          const coordInput = document.getElementById("coordinates");
          for (const [key, coords] of Object.entries(localGeocodingData)) {
            if (key.toLowerCase().includes(normalizedQuery)) {
              placeMarker(coords, key);
              coordInput.value = `${coords[0]},${coords[1]}`; // Explicitly set coordinates
              return;
            }
          }

          alert(
            "Address not found. Try landmarks like 'Town Plaza' or connect to the internet."
          );
        }

        // Event listeners
        document
          .getElementById("search-button")
          .addEventListener("click", searchAddress);
        document
          .getElementById("address-search")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") searchAddress();
          });

        // Form validation
        document
          .getElementById("eventReportForm")
          .addEventListener("submit", function (e) {
            if (!document.getElementById("coordinates").value) {
              e.preventDefault();
              alert("Please select a location on the map before submitting");
            }
          });

        // Fullscreen handling
        map.on("fullscreenchange", function () {
          setTimeout(function () {
            map.invalidateSize();
            if (marker) map.panTo(marker.getLatLng());
          }, 100);
        });
      });
    </script>
  </body>
</html>
